{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_kpi_metrics",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrdersSummary",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "WITH Query1 AS (\n    SELECT \n        SUM(p.\"Amount\") as \"Local Expense\",\n        p2.\"Currency\",\n  SUM(CASE WHEN p2.\"Currency\" = 'CAD' THEN p.\"Amount\" / {{appsmith.store.currency.CAD}}\n           WHEN p2.\"Currency\" = 'GBP' THEN p.\"Amount\" / {{appsmith.store.currency.GBP}}\n\t\t\t\t\t WHEN p2.\"Currency\" = 'AUD' THEN p.\"Amount\" / {{appsmith.store.currency.AUD}}\n           ELSE p.\"Amount\" END) as \"Expense (USD Convesion)\",\n  c1.\"CustomerName\" as \"ClientName\"\n    FROM \"public\".\"Invoice\" i \n        INNER JOIN \"public\".\"PrinterLineItems\" p ON ( p.\"InvoiceID\" = i.\"InvoiceID\"  )  \n        INNER JOIN \"public\".\"PrinterPrice\" p1 ON ( p1.\"Id\" = p.\"PrinterPriceID\"  )  \n        INNER JOIN \"public\".\"Printers\" p2 ON ( p2.\"Id\" = p1.\"PrinterID\"  )  \n        INNER JOIN \"public\".\"Customers\" c1 ON ( c1.\"Id\" = i.\"CustomerID\"  )  \n   WHERE  to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') >= DATE '{{moment(DatePicker1.selectedDate).format(\"YYYY-MM-DD\")}}' AND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') <= DATE '{{moment(DatePicker2.selectedDate).format(\"YYYY-MM-DD\")}}'\n       GROUP BY \n        c1.\"CustomerName\", p2.\"Currency\"\n),\nQuery2 AS (\n    SELECT \n        SUM(c.\"Amount\") as \"Revenue\",\n        p2.\"Currency\" as \"RevenueCurrency\",\n        SUM(CASE \n                WHEN   i.\"InvoiceStatus\" ='PAID' THEN c.\"Amount\"\n                ELSE 0\n            END) as \"Amount Paid\",\n\t        SUM(CASE \n                WHEN  i.\"InvoiceStatus\" !='PAID' THEN c.\"Amount\" \n                ELSE 0\n            END) as \"Balance\",\n        c1.\"CustomerName\" as \"ClientName\"\n    FROM \"public\".\"Invoice\" i \n        INNER JOIN \"public\".\"CustomerLineItems\" c ON ( c.\"InvoiceID\" = i.\"InvoiceID\"  )  \n        INNER JOIN \"public\".\"Printers\" p2 ON ( p2.\"PrinterName\" = c.\"Printer\"  )  \n        INNER JOIN \"public\".\"Customers\" c1 ON ( c1.\"Id\" = i.\"CustomerID\"  )  \n   WHERE  to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') >= DATE '{{moment(DatePicker1.selectedDate).format(\"YYYY-MM-DD\")}}' AND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') <= DATE '{{moment(DatePicker2.selectedDate).format(\"YYYY-MM-DD\")}}'\n       GROUP BY \n        c1.\"CustomerName\", p2.\"Currency\"\n)\nSELECT \n    --COALESCE(q1.\"ClientName\", q2.\"ClientName\") as \"ClientName\",\n    --COALESCE(q1.\"Currency\", q2.\"RevenueCurrency\") as \"Currency\",\n    --SUM(COALESCE(q1.\"Local Expense\", 0) ) as \"Local Expense\",\n    SUM(COALESCE(q1.\"Expense (USD Convesion)\", 0) ) as \"ExpenseToUSD\",\n    SUM(COALESCE(q2.\"Revenue\", 0) ) as \"Revenue\",\n    SUM(COALESCE(q2.\"Balance\", 0) ) as \"Balance\",\n\tSUM(COALESCE(q2.\"Amount Paid\", 0) )as \"AmountPaid\"\nFROM \n    Query1 q1\nFULL OUTER JOIN \n    Query2 q2 ON q1.\"ClientName\" = q2.\"ClientName\" AND q1.\"Currency\" = q2.\"RevenueCurrency\"\n--ORDER BY \n--    LOWER(COALESCE(q1.\"ClientName\", q2.\"ClientName\")) ASC;",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "appsmith.store.currency.AUD",
      "appsmith.store.currency.CAD",
      "appsmith.store.currency.GBP",
      "moment(DatePicker1.selectedDate).format(\"YYYY-MM-DD\")",
      "moment(DatePicker2.selectedDate).format(\"YYYY-MM-DD\")"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": [],
    "createdAt": "2023-11-21T15:19:27Z"
  },
  "id": "OrdersSummary_get_kpi_metrics",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_655cca7f54ea911e4c3f807d"
}