{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_draftorders",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 1000000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "WITH customer_line_items_query AS (\n\tSELECT\n\tc1.\"CustomerName\",\n\tc3.\"Id\",\n\tc3.\"InvoiceID\",\n\tc3.\"CustomerPriceID\",\n\tc3.\"Qty\",\n\tc3.\"Rate\",\n\tc3.\"Amount\",\n\tc3.\"SubItemID\",\n\tc3.\"Printer\",\n\tc3.\"OrderStatus\",\n\tc3.\"Notes\",\n\tc3.\"Destination\",\n\ti.\"InvoiceDate\",\n\ti.\"PaymentMethod\",\n\ti.\"InvoiceStatus\",\n\ti.\"OrderStatus\" AS \"InvoiceOrderStatus\"\n\tFROM\n\t\"public\".\"Customers\" c1\n\tINNER JOIN \"public\".\"CustomerPrice\" c2 ON (c2.\"CustomerID\" = c1.\"Id\")\n\tINNER JOIN \"public\".\"CustomerLineItems\" c3 ON (c3.\"CustomerPriceID\" = c2.\"Id\")\n\tINNER JOIN \"public\".\"Invoice\" i ON (i.\"InvoiceID\" = c3.\"InvoiceID\")\n\tWHERE\n\tEXISTS (\n\t\tSELECT p.\"ProductDescription\"\n\t\tFROM \"public\".\"Products\" p\n\t\tWHERE p.\"Id\" = c2.\"ProductID\"\n\t)\n\tAND \"SubItemID\" IS NULL\n\tAND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') >= '{{moment(DatePicker1.selectedDate).format('YYYY-MM-DD')}}'\n\tAND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') <= '{{moment(DatePicker1.selectedDate).format('YYYY-MM-DD')}}'\n),\ncategory_tree_query AS (\n\tWITH RECURSIVE category_tree AS (\n\t\tSELECT\n\t\t\"Id\",\n\t\t\"SubItemID\",\n\t\t\"InvoiceID\",\n\t\t\"Qty\",\n\t\t\"CustomerPriceID\",\n\t\t\"Amount\",\n\t\t\"Printer\",\n\t\t\"Destination\"\n\t\tFROM\n\t\t\"CustomerLineItems\"\n\t\tWHERE\n\t\t\"SubItemID\" IS NULL -- start with top-level categories\n\t\tUNION ALL\n\t\tSELECT\n\t\toi.\"Id\",\n\t\toi.\"SubItemID\",\n\t\toi.\"InvoiceID\",\n\t\toi.\"Qty\",\n\t\toi.\"CustomerPriceID\",\n\t\toi.\"Amount\",\n\t\toi.\"Printer\",\n\t\toi.\"Destination\"\n\t\tFROM\n\t\t\"CustomerLineItems\" oi\n\t\tJOIN category_tree ct ON oi.\"SubItemID\" = ct.\"Id\"\n\t),\n\ttotal_amount AS (\n\t\tSELECT SUM(\"Amount\") AS total FROM category_tree\n\t)\n\tSELECT\n\tCOALESCE(it.\"SubItemID\", it.\"Id\") AS \"Id\",\n\tstring_agg(p.\"ProductDescription\", ' ➤ ') AS \"OrderDetails\",\n\tSUM(it.\"Amount\") AS \"Summary\"\n\tFROM\n\tcategory_tree it\n\tJOIN \"public\".\"CustomerPrice\" c2 ON (it.\"CustomerPriceID\" = c2.\"Id\")\n\tJOIN \"public\".\"Products\" p ON (p.\"Id\" = c2.\"ProductID\")\n\tGROUP BY\n\tCOALESCE(it.\"SubItemID\", it.\"Id\")\n\tORDER BY\n\t\"OrderDetails\" ASC\n),\nfiltered_category_tree_query AS (\n\tSELECT *\n\tFROM category_tree_query\n\t-- WHERE \"OrderDetails\" LIKE '%BW SS - First Class%'\n),\nprinter_line_items_query AS (\n\tSELECT\n\tmain_items.\"Id\" AS \"Id\",\n\tCONCAT_WS(' ➤ ', main_items.\"InitialProdDescription\", string_agg(\n    CASE\n      WHEN sub_items.\"InitialProdDescription\" ILIKE '%Extra%' OR sub_items.\"InitialProdDescription\" ILIKE '%add%'\n      THEN\n        '(' || sub_items_qty.\"Qty\" / main_items.\"Qty\" || ') ' || sub_items.\"InitialProdDescription\"\n      ELSE\n        sub_items.\"InitialProdDescription\" \n      END, ' ➤ '\n    )) AS \"OrderDetailsPrinter\",\n\tCOALESCE(main_items.\"Amount\", 0) + COALESCE(sub_items_total.\"Amount\", 0) AS \"PSummary\"\n\tFROM\n\t\"PrinterLineItems\" AS main_items\n\tLEFT JOIN (\n\t\tSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\"\n\t\tFROM \"PrinterLineItems\"\n\t\tWHERE \"SubItemID\" IS NOT NULL\n\t\tGROUP BY \"SubItemID\"\n\t) sub_items_total ON main_items.\"Id\" = sub_items_total.\"SubItemID\"\n\tLEFT JOIN (\n\t\tSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\", \"InitialProdDescription\"\n\t\tFROM \"PrinterLineItems\"\n\t\tWHERE \"SubItemID\" IS NOT NULL\n\t\tGROUP BY \"SubItemID\", \"InitialProdDescription\"\n\t) sub_items ON main_items.\"Id\" = sub_items.\"SubItemID\"\n\tLEFT JOIN (\n\t\tSELECT \"SubItemID\", \"Qty\"\n\t\tFROM \"PrinterLineItems\"\n\t\tWHERE \"SubItemID\" IS NOT NULL AND (\"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%')\n\t\tGROUP BY \"SubItemID\", \"Qty\"\n\t) sub_items_qty ON main_items.\"Id\" = sub_items_qty.\"SubItemID\"\n\tINNER JOIN \"public\".\"Invoice\" i ON i.\"InvoiceID\" = main_items.\"InvoiceID\"\n\tINNER JOIN \"Customers\" c1 ON (c1.\"Id\" = i.\"CustomerID\")\n\tINNER JOIN \"PrinterPrice\" p1 ON (p1.\"Id\" = main_items.\"PrinterPriceID\")\n\tINNER JOIN \"Products\" p2 ON (p2.\"Id\" = p1.\"ProductID\")\n\tWHERE\n\tmain_items.\"SubItemID\" IS NULL\n\tGROUP BY\n\tmain_items.\"Id\",\n\tmain_items.\"InitialProdDescription\",\n\tsub_items_total.\"Amount\"\n\tORDER BY\n\tmain_items.\"Id\" ASC\n),\ngrouped_query AS (\n\tSELECT\n\tCASE\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Glory%' THEN 'BW DS - FC Generic - Credit Glory Inc'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Credit Sage LLC%' THEN 'BW DS - FC Generic - Credit Sage LLC Inc'\n\tWHEN customer_line_items_query.\"CustomerName\" LIKE '%ECA GreenTech%' THEN 'ECA Greentech'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Certified Mail RR - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Certified Mail RR - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Certified Mail RR - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Certified Mail RR - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Certified Mail NRR - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Certified Mail NRR - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Certified Mail NRR - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Certified Mail NRR - CLR DS'\n\tWHEN customer_line_items_query.\"CustomerName\"  LIKE '%swyftconnect%'  THEN 'swyftconnect Return Envelope'\n\tWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Highland%'  THEN 'Highland Health Direct FFW Custom Envelope'\t\n\tWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Titanvest%'  THEN 'Titanvest Return Envelope'\n\tWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Octopus Energy%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%#9 Envelope%'  THEN 'Octopus Energy Return Envelope'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#9 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Return Envelope - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#9 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Return Envelope - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Custom Envelope - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Custom Envelope - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Custom Envelope - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Custom Envelope - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%SameDay%'  AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Cheque add''l Sheet%' THEN 'SameDay Cheques w/ Docs'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%SameDay%'  AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Cheque Only%' THEN 'SameDay Cheques Only'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%' THEN 'International Delivery - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%' THEN 'International Delivery - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%' THEN 'International Delivery - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%' THEN 'International Delivery - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 4x6%' THEN 'International Delivery -Postcard 4x6'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 6x9%' THEN 'International Delivery -Postcard 6x9'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 6x11%' THEN 'International Delivery -Postcard 6x11'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express- CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express- CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Perforated - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Perforated - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPerforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Perforated - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Perforated - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Perforated - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Perforated - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Perforated - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Perforated- CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Registered Mail - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Registered Mail - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Registered Mail - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Registered Mail - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Registered Mail - BW SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Registered Mail - BW DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Registered Mail - CLR SS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Registered Mail - CLR DS'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Cheque add''l Sheet%' THEN 'Letter Size - Cheques with Documents'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - Cheque Only%' THEN 'Letter Size - Cheques Only'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - Cheque Only%' THEN 'A4 Size - Cheques Only'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%4x6 Lamination%' THEN 'Postcard 4x6 Lamination - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x9 Lamination%' THEN 'Postcard 6x9 Lamination - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x11 Lamination%' THEN 'Postcard 6x11 Lamination - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%4x6 Lamination%' THEN 'Postcard 4x6 Lamination - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x9 Lamination%' THEN 'Postcard6x9 Lamination - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x11 Lamination%' THEN 'Postcard 6x11 Lamination - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - First Class%' THEN 'Postcard 4x6 - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - First Class%' THEN 'Postcard 6x9 - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - First Class%' THEN 'Postcard 6x11 - First Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Standard Class%' THEN 'Postcard 4x6 - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Standard Class%' THEN 'Postcard 6x9 - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Standard Class%' THEN 'Postcard 6x11 - Standard Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Lettermail%' THEN 'Postcard 4x6 - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Lettermail%' THEN 'Postcard 6x9 - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Lettermail%' THEN 'Postcard 6x11 - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Personalized%' THEN 'Postcard 4x6 - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Personalized%' THEN 'Postcard 6x9 - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Personalized%' THEN 'Postcard 6x11 - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Second Class%' THEN 'Postcard 4x6 - Second Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Second Class%' THEN 'Postcard 6x9 - Second Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Second Class%' THEN 'Postcard 6x11 - Second Class'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - First Class%' THEN 'Letter Size - BW SS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - First Class%' THEN 'Letter Size - BW DS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - First Class%' THEN 'Letter Size - CLR SS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - First Class%' THEN 'Letter Size - CLR DS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Standard Class%' THEN 'Letter Size - BW SS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Standard Class%' THEN 'Letter Size - BW DS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Standard Class%' THEN 'Letter Size - CLR SS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Standard Class%' THEN 'Letter Size - CLR DS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Lettermail%' THEN 'Letter Size - BW SS - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Lettermail%' THEN 'Letter Size - BW DS - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Lettermail%' THEN 'Letter Size - CLR SS - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Lettermail%' THEN 'Letter Size - CLR DS - Lettermail'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Personalized%' THEN 'Letter Size - BW SS - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Personalized%' THEN 'Letter Size - BW DS - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Personalized%' THEN 'Letter Size - CLR SS - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Personalized%' THEN 'Letter Size - CLR DS - Personalized'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW SS - First Class%' THEN 'A4 Size - BW SS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW DS - First Class%' THEN 'A4 Size - BW DS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR SS - First Class%' THEN 'A4 Size - CLR SS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR DS - First Class%' THEN 'A4 Size - CLR DS - FC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW SS - Second Class%' THEN 'A4 Size - BW SS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW DS - Second Class%' THEN 'A4 Size - BW DS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR SS - Second Class%' THEN 'A4 Size - CLR SS - SC Generic'\n\tWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR DS - Second Class%' THEN 'A4 Size - CLR DS - SC Generic'\n\tELSE filtered_category_tree_query.\"OrderDetails\"\n\tEND AS \"GroupDetails\",\n\tSUM(customer_line_items_query.\"Qty\") AS \"QtyTotal\",\n\tcustomer_line_items_query.\"CustomerName\",\n\tcustomer_line_items_query.\"Qty\",\n\tcustomer_line_items_query.\"Id\",\n\tprinter_line_items_query.\"OrderDetailsPrinter\",\n\tprinter_line_items_query.\"PSummary\",\n\tcustomer_line_items_query.\"Destination\"\n\tFROM\n\tcustomer_line_items_query\n\tJOIN filtered_category_tree_query ON customer_line_items_query.\"Id\" = filtered_category_tree_query.\"Id\"\n\tJOIN printer_line_items_query ON customer_line_items_query.\"Id\" = printer_line_items_query.\"Id\"\n\tWHERE\n\tcustomer_line_items_query.\"Printer\" = '{{Select3.selectedOptionLabel}}'\n\tGROUP BY\n\t\"GroupDetails\",\n\tcustomer_line_items_query.\"CustomerName\",\n\tcustomer_line_items_query.\"Qty\",\n\tcustomer_line_items_query.\"Id\",\n\tprinter_line_items_query.\"OrderDetailsPrinter\",\n\tprinter_line_items_query.\"PSummary\",\n\tcustomer_line_items_query.\"Destination\"\n)\n\nSELECT\n  CASE\n    WHEN ROW_NUMBER() OVER (PARTITION BY \"GroupDetails\" ORDER BY \"GroupDetails\") = 1 THEN SUM(\"QtyTotal\") OVER (PARTITION BY \"GroupDetails\")\n    ELSE NULL\n  END AS \"OrderCounts\",\n  \"GroupDetails\" AS \"Collaterals\",\n  \"CustomerName\" AS \"Clients\",\n\t\"Id\",\n  \"Qty\" || ' ' || \"OrderDetailsPrinter\" AS \"OrderDetails\",\n\t(\n\t\tWITH RECURSIVE item_tree(\"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", depth, \"Destination\") AS (\n\t\t\tSELECT \"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", 0, \"Destination\"\n\t\t\tFROM \"public\".\"PrinterLineItems\"\n\t\t\tWHERE \"SubItemID\" IS NULL\n\t\t\tUNION ALL\n\t\t\tSELECT oi.\"Id\", oi.\"SubItemID\", oi.\"InvoiceID\", oi.\"Qty\", oi.\"InitialProdDescription\", oi.\"Amount\", oi.\"PrinterPriceID\", oi.\"Rate\", oi.\"Printer\", depth + 1, oi.\"Destination\"\n\t\t\tFROM \"public\".\"PrinterLineItems\" oi\n\t\t\tJOIN item_tree t ON oi.\"SubItemID\" = t.\"Id\"\n\t\t),\n\t\titemsubitems AS (\n\t\t\tSELECT * FROM item_tree tt\n\t\t\tWHERE \"Id\" = grouped_query.\"Id\" OR \"SubItemID\" = grouped_query.\"Id\"\n\t\t\tORDER BY COALESCE(tt.\"SubItemID\", tt.\"Id\"), tt.\"Id\"\n\t\t)\n\t\tSELECT \n\t\tCASE \n\t\tWHEN COUNT(*) = 1 OR (COUNT(*) = 2 AND EXISTS (SELECT 1 FROM itemsubitems WHERE \"InitialProdDescription\"\tILIKE  '%Envelope%'))  THEN (\n\t\t\tSELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' * (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t)  || ') = ' || (\n\t\t\tSELECT SUM(\"Amount\") FROM itemsubitems\n\t\t)\n\t\tWHEN NOT EXISTS (SELECT 1 FROM itemsubitems WHERE \"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%') THEN (\n\t\t\tSELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' * (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || (\n\t\t\tSELECT STRING_AGG(' + ' || \"Rate\", '') FROM (SELECT \"Rate\" FROM  itemsubitems WHERE \"InitialProdDescription\"\tNOT ILIKE  '%Envelope%' AND \"SubItemID\" IS NOT NULL) as sub\n\t\t) || ') = ' || (\n\t\t\tSELECT SUM(\"Amount\") FROM itemsubitems\n\t\t)\n\t\tWHEN COUNT(*) = 2 OR (COUNT(*) = 3 AND EXISTS (SELECT 1 FROM itemsubitems WHERE \"InitialProdDescription\"\tILIKE  '%Envelope%')) THEN\n\t\t(\n\t\t\tSELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' * (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' + (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%' LIMIT 1\n\t\t) || ' * ' || (\n\t\t\t((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n\t\t) || ')' || ') = ' || (\n\t\t\tSELECT SUM(\"Amount\") FROM itemsubitems\n\t\t)\n\t\tELSE (\n\t\t\tSELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' * (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n\t\t) || ' + (' || (\n\t\t\tSELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%' LIMIT 1\n\t\t) || ' * ' || (\n\t\t\t((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" ILIKE '%Extra%' OR \"InitialProdDescription\" ILIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n\t\t) || ')' || (\t\n\t\t\tSELECT STRING_AGG(' + ' || \"Rate\", '') FROM (SELECT \"Rate\" FROM  itemsubitems WHERE  \"InitialProdDescription\"\tNOT ILIKE  '%Extra%' AND \"InitialProdDescription\"\tNOT ILIKE  '%add%' AND \"InitialProdDescription\"\tNOT ILIKE  '%Envelope%'  OFFSET 1) as sub\n\t\t) || ') = ' || (\n\t\t\tSELECT SUM(\"Amount\") FROM itemsubitems\n\t\t)\n\t\tEND AS formula \n\t\tFROM itemsubitems\n\t) AS result,\n  \"PSummary\" AS \"Subtotal\",\n  \"Destination\" AS \"To\"\nFROM\n  grouped_query\nORDER BY\n  \"GroupDetails\" ASC;",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": false,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [
      "'Query timeout' field must be an integer between 0 and 60000"
    ],
    "messages": [],
    "jsonPathKeys": [
      "Select3.selectedOptionLabel",
      "moment(DatePicker1.selectedDate).format('YYYY-MM-DD')"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": [],
    "createdAt": "2023-05-10T21:04:12Z"
  },
  "id": "OrderEmailDrafting_get_draftorders",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_645c06ccda60c6288bd79510"
}